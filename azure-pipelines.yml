stages:
- stage: Build
  jobs:
  - job: BuildJob
    pool:
      name: Azure Pipelines
      demands:
      - msbuild
      - visualstudio
      vmImage: 'windows-2019'

    variables:
      solution: '**\src\VSTSDemoGeneratorV2.sln'
      artifactName: 'drop'

    steps:
    - task: NuGetToolInstaller@0
      displayName: 'Use NuGet 5.11.0'
      inputs:
        versionSpec: 5.11.0

    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: '$(solution)'

    - task: VSBuild@1
      displayName: 'Build solution'
      inputs:
        solution: '$(solution)'
        msbuildArgs: '/p:Configuration=Debug /p:Platform="Any CPU" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'

    - task: CopyFiles@1
      displayName: 'Copy Files to: $(build.sourcesdirectory)\src\VstsDemoBuilder\obj\Release\Package\PackageTmp'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)\' 
        Contents: '**\*'
        TargetFolder: '$(build.sourcesdirectory)\Artifacts'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        PathtoPublish: '$(build.sourcesdirectory)\Artifacts'
        ArtifactName: '$(artifactName)'


- stage: Production
  dependsOn: Build
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  displayName: Production Deployment
  jobs: 
  - deployment: DeployWeb
    displayName: Deploy to Production Environment

    environment: 
      name: 'Production'

    strategy:
      runOnce:
        deploy:
          pool: 
            vmImage: 'windows-2019'
          steps:
            - task: DownloadBuildArtifacts@0
              displayName: 'Download Build Artifacts'
              inputs:
                buildType: 'current'
                downloadType: 'single'
                artifactName: 'drop'
                downloadPath: '$(System.DefaultWorkingDirectory)'
            
            - task: AzureRmWebAppDeployment@4
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: 'demogen-test'
                appType: webApp
                WebAppName: 'dgnew'
                AppSettings: '-DefaultTemplate eShopOnWeb -Password $(Password) -ClientId $(ClientId) -ClientSecret $(ClientSecret) -RedirectUri $(RedirectUri) -AppScope $(AppScope)'

            # - task: AzureAppServiceSettings@1
            #   inputs:
            #     azureSubscription: 'demogen-test'
            #     appName: 'dgnew'
            #     resourceGroupName: 'landmark'
            #     appSettings: '-DefaultTemplate eShopOnWeb -Password $(Password) -ClientId $(ClientId) -ClientSecret $(ClientSecret) -RedirectUri $(RedirectUri) -AppScope $(AppScope)'